<div class="modal-header align-items-center">
  <h4 class="modal-title">
    <fa-icon [icon]="icons.links" class="me-2"></fa-icon>
    <span>{{ linkForm.value.name || linkForm.value.shareName }}</span>
  </h4>
  <h4 class="modal-title ms-auto">
    @if (share?.id || link?.id) {
      <span l10nTranslate>Edit link</span>
    } @else {
      <span l10nTranslate>New link</span>
    }
  </h4>
  <button (click)="layout.closeDialog()" aria-label="Close" class="btn-close btn-close-white ms-2" type="button"></button>
</div>
<div class="modal-body">
  @if (share || link) {
    <div class="card dialog-tab-card mb-3">
      <div class="card-body">
        <div class="d-flex align-items-start gap-3">
          <div class="flex-grow-1 min-width-0">
            <div class="d-flex align-items-center text-truncate">
              <fa-icon [icon]="icons.links" class="circle-primary-icon me-2"></fa-icon>
              <div class="d-flex flex-column text-truncate">
                <span class="text-truncate">{{ linkForm.value.name || linkForm.value.shareName }}</span>
                <span class="fs-xxxs text-truncate">{{ linkForm.value.email }}</span>
              </div>
            </div>
            @if (share) {
              <div class="d-flex align-items-center d-none d-sm-flex pt-2">
                <app-share-repository id="file" [share]="share" [showIcon]="true" [showFullPath]="true"></app-share-repository>
              </div>
            }
          </div>
          <div class="d-flex flex-nowrap">
            @if (share && permissions) {
              @for (p of permissions| keyvalue: originalOrderKeyValue; track p.key; let last = $last) {
                <button btnCheckbox
                        [(ngModel)]="permissions[p.key]"
                        (ngModelChange)="onPermissionChange()"
                        [tooltip]="SPACES_PERMISSIONS_TEXT[p.key].text | translate:locale.language"
                        class="btn btn-sm btn-custom me-0 ms-2"
                        type="button">
                  <fa-icon [icon]="SPACES_PERMISSIONS_TEXT[p.key].icon" size="lg"></fa-icon>
                </button>
                @if (last) {
                  <div class="vr mx-2"></div>
                }
              }
            }
            <button (click)="copyToClipboard()"
                    class="btn btn-sm {{linkWasCopied ? 'btn-info' : 'btn-secondary'}}"
                    [tooltip]="'Copy link' | translate:locale.language"
                    container="body"
                    type="button">
              <fa-icon [icon]="linkWasCopied ? icons.faClipboardCheck : icons.faClipboard" size="lg"></fa-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
  }
  <form [formGroup]="linkForm" autocomplete="off">
    <div class="row g-3">
      <div class="col-12 col-lg-6 d-flex flex-column gap-3">
        <div class="card dialog-tab-card">
          <div class="card-body d-flex flex-column">
            <div class="text-muted text-uppercase fs-xxxs fw-semibold mb-2" l10nTranslate>Link identity</div>

            <div class="d-flex align-items-center cursor-pointer py-2"
                 (mouseover)="linkIsHovered = true"
                 (mouseleave)="linkIsHovered = false"
                 (focus)="linkIsHovered = true"
                 (blur)="linkIsHovered = false"
                 (click)="copyToClipboard()">
              <span class="form-label mb-0" l10nTranslate>Link</span>
              <span id="link" [class.text-primary]="linkIsHovered" class="ms-auto text-truncate ps-2">
                {{ share ? share.link.uuid : link.uuid }}
              </span>
            </div>

            <hr class="my-1">

            <div class="card dialog-check-card dialog-check-card--interactive mt-3"
                 [class.dialog-check-card--active]="linkForm.controls.isActive.value"
                 (click)="toggleIsActiveFromCard()">
              <div class="card-body p-2">
                <div class="d-flex align-items-center">
                  <label class="form-label cursor-pointer me-auto mb-0"
                         for="state"
                         (click)="$event.stopPropagation()"
                         l10nTranslate>
                    Active
                  </label>
                  <div class="d-flex align-items-center form-check form-switch cursor-pointer">
                    <input
                      id="state"
                      class="form-check-input"
                      formControlName="isActive"
                      (click)="$event.stopPropagation()"
                      type="checkbox"
                      role="button">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card dialog-tab-card">
          <div class="card-body d-flex flex-column">
            <div class="text-muted text-uppercase fs-xxxs fw-semibold mb-2" l10nTranslate>Access rules</div>

            <div class="d-flex align-items-center py-2">
              <span class="form-label mb-0" l10nTranslate>Current access count</span>
              <span id="access" class="ms-auto">
                @if (linkForm.value.limitAccess) {
                  <span class="badge rounded-pill {{(share ? share.link.nbAccess : link.nbAccess) >= linkForm.value.limitAccess ? 'bg-danger': 'bg-success'}}">
                    {{ (share ? share.link.nbAccess : link.nbAccess) }}/{{ linkForm.value.limitAccess }}
                  </span>
                } @else {
                  <span class="badge rounded-pill bg-success">{{ share ? share.link.nbAccess : link.nbAccess }}</span>
                }
              </span>
            </div>
            <hr class="my-1">
            <div class="row g-2 align-items-center mt-2 mb-2">
              <label class="form-label col-5 mb-0" for="limitAccess" l10nTranslate>Limit access</label>
              <div class="col-7">
                <input id="limitAccess"
                       formControlName="limitAccess"
                       min="1"
                       type="number"
                       class="form-control form-control-sm"
                       [placeholder]="'Unlimited' | translate:locale.language">
              </div>
            </div>
            <div class="row g-2 align-items-center">
              <label class="form-label col-5 mb-0" for="expiration" l10nTranslate>Expiration</label>
              <div class="col-7">
                <input
                  bsDatepicker
                  id="expiration"
                  formControlName="expiresAt"
                  placement="left"
                  type="text"
                  class="form-control form-control-sm"
                  [class.text-danger]="linkIsExpired"
                  [placeholder]="'Never expires' | translate:locale.language"
                  [bsConfig]="{
                    dateInputFormat: 'YYYY-MM-DD',
                    containerClass: 'theme-dark-blue',
                    returnFocusToInput: true,
                    minDate: minDate,
                    showWeekNumbers: false
                  }">
              </div>
            </div>
          </div>
        </div>
        <div class="card dialog-tab-card">
          <div class="card-body d-flex flex-column">
            <div class="text-muted text-uppercase fs-xxxs fw-semibold mb-2" l10nTranslate>Security</div>
            <div class="card dialog-check-card dialog-check-card--interactive"
                 [class.dialog-check-card--active]="linkForm.value.requireAuth"
                 (click)="toggleRequireAuth()">
              <div class="card-body p-2">
                <div class="d-flex align-items-center">
                  <label for="requireAuth"
                         class="form-label cursor-pointer me-auto mb-0"
                         (click)="$event.stopPropagation()"
                         l10nTranslate>
                    Password
                  </label>
                  @if (linkForm.value.requireAuth && password !== defaultPassword) {
                    <div class="d-flex align-items-center d-none d-sm-flex mx-auto">
                      <app-password-strength-bar [passwordToCheck]="password"></app-password-strength-bar>
                    </div>
                  }
                  <div class="d-flex align-items-center form-check form-switch cursor-pointer">
                    <input id="requireAuth"
                           class="form-check-input"
                           formControlName="requireAuth"
                           (click)="$event.stopPropagation()"
                           type="checkbox"
                           role="button">
                  </div>
                </div>
              </div>
            </div>
            <app-input-password [isRequired]="linkForm.value.requireAuth"
                                [disabled]="!linkForm.value.requireAuth"
                                [passwordMinLength]="passwordMinLength"
                                [(password)]="password"
                                [showGenerator]="true"
                                placeholder="Set a password"
                                class="mt-2 w-100">
            </app-input-password>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6 d-flex flex-column gap-3">
        @if (share) {
          <div class="card dialog-tab-card">
            <div class="card-body d-flex flex-column">
              <div class="text-muted text-uppercase fs-xxxs fw-semibold mb-2" l10nTranslate>Share details</div>
              <div class="row g-2 align-items-center mb-2">
                <label class="form-label col-5 mb-0" for="shareName" l10nTranslate>Share name</label>
                <div class="col-7">
                  <input id="shareName"
                         formControlName="shareName"
                         type="text"
                         class="form-control form-control-sm"
                         [class.is-invalid]="linkForm.controls.shareName.invalid"
                         [placeholder]="'Share name' | translate:locale.language">
                </div>
              </div>
              <div class="row g-2 align-items-center mb-2">
                <label class="form-label col-5 mb-0" for="shareDescription" l10nTranslate>Description</label>
                <div class="col-7">
                  <input id="shareDescription"
                         formControlName="shareDescription"
                         type="text"
                         class="form-control form-control-sm">
                </div>
              </div>
            </div>
          </div>
        }
        <div class="card dialog-tab-card flex-grow-1">
          <div class="card-body d-flex flex-column">
            <div class="text-muted text-uppercase fs-xxxs fw-semibold mb-2" l10nTranslate>Guest profile</div>
            <div class="row g-2 align-items-center mb-2">
              <label class="form-label col-5 mb-0" for="guestName" l10nTranslate>Guest name</label>
              <div class="col-7">
                <input id="guestName"
                       formControlName="name"
                       type="text"
                       class="form-control form-control-sm"
                       [placeholder]="'Guest name' | translate:locale.language">
              </div>
            </div>
            <div class="row g-2 align-items-center mb-2">
              <label class="form-label col-5 mb-0" for="guestEmail" l10nTranslate>Guest email</label>
              <div class="col-7">
                <input id="guestEmail"
                       autocomplete="off"
                       formControlName="email"
                       [class.is-invalid]="linkForm.controls.email.invalid"
                       type="email"
                       class="form-control form-control-sm"
                       [placeholder]="'Guest email' | translate:locale.language">
              </div>
            </div>
            <div class="row g-2 align-items-center">
              <label class="form-label col-5 mb-0" for="guestLanguage" l10nTranslate>Guest language</label>
              <div class="col-7">
                <select id="guestLanguage"
                        formControlName="language"
                        class="form-control form-select form-select-sm">
                  @for (l of languages; track $index) {
                    <option [ngValue]="l">{{ i18nLanguageText[l] }}</option>
                  }
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
<div class="modal-footer">
  @if (share?.id) {
    <button (click)="confirmDeletion = true"
            [disabled]="confirmDeletion"
            class="btn btn-sm btn-danger" type="button" l10nTranslate>
      Remove
    </button>
  }
  <button (click)="onCancel()" class="btn btn-sm btn-secondary ms-auto" data-dismiss="modal" type="button" l10nTranslate>Cancel</button>
  <button (click)="onSubmit()"
          [disabled]="linkForm.invalid || linkForm.controls.requireAuth.value && password.length < passwordMinLength || submitted"
          class="btn btn-sm {{confirmDeletion ? 'btn-danger' : 'btn-primary'}}"
          type="button"
          l10nTranslate>
    {{ confirmDeletion ? 'Confirm deletion' : 'Confirm' }}
  </button>
</div>
