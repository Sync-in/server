<div class="modal-header align-items-center">
  <h4 class="modal-title">
    <fa-icon [icon]="icons.faKey" class="me-2"></fa-icon>
    <span l10nTranslate>Manage app passwords</span>
  </h4>
  <button (click)="onClose()" aria-label="Close" class="btn-close btn-close-white ms-auto" type="button"></button>
</div>
<div class="modal-body">
  <div class="d-flex flex-column gap-3">
    <div class="card dialog-tab-card">
      <div class="card-body p-3">
        <div class="d-flex align-items-center text-muted text-uppercase fs-3xs fw-semibold mb-3">
          <span l10nTranslate>Generate a new app password</span>
        </div>
        <form [formGroup]="appPasswordForm" (ngSubmit)="genAppPassword()">
          <div class="row g-2">
            <div class="col-12 col-md-4">
              <label class="form-label" for="name" l10nTranslate>Password name</label>
              <input
                appAutofocus
                id="name"
                name="name"
                formControlName="name"
                type="text"
                class="form-control form-control-sm"
                [class.is-invalid]="appPasswordForm.controls.name.invalid"
                [placeholder]="'Password name' | translate: locale.language"
                required>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="app" l10nTranslate>Application</label>
              <select id="app" class="form-select form-select-sm" formControlName="app">
                @for (s of availableApps; track $index) {
                  <option [value]="s" l10nTranslate>{{ s | capitalize }}</option>
                }
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="expiration" l10nTranslate>Expiration</label>
              <input
                bsDatepicker
                id="expiration"
                formControlName="expiration"
                placement="bottom"
                type="text"
                class="form-control form-control-sm"
                [placeholder]="'Never expires' | translate:locale.language"
                [bsConfig]="{
                  dateInputFormat: 'YYYY-MM-DD',
                  containerClass: 'theme-dark-blue',
                  returnFocusToInput: true,
                  minDate: minDate,
                  showWeekNumbers: false }">
            </div>
            <div class="col-12 col-md-9 d-flex align-items-end">
              <div class="w-100">
                @if (hasError) {
                  <div class="alert alert-danger py-2 px-3 mb-0 text-center" l10nTranslate>
                    {{ hasError }}
                  </div>
                } @else {
                  <div class="alert alert-secondary py-2 px-3 mb-0 text-center" l10nTranslate>
                    This password will only be shown once after it is generated
                  </div>
                }
              </div>
            </div>
            <div class="col-12 col-md-3 d-flex align-items-end">
              <button
                [disabled]="appPasswordForm.invalid || submitted"
                class="btn btn-sm btn-primary ms-auto"
                type="submit"
                l10nTranslate>
                Generate
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
    @if (generatedPassword) {
      <div class="card dialog-check-card border-success-subtle bg-success-subtle">
        <div class="card-body p-3">
          <div class="d-flex align-items-center text-success-emphasis text-uppercase fs-3xs fw-semibold mb-2">
            <fa-icon [icon]="icons.faKey" class="me-2"></fa-icon>
            <span l10nTranslate>Password generated</span>
          </div>
          <div class="row g-2 mb-2">
            <div class="col-12 col-md-4">
              <div class="card dialog-check-card h-100">
                <div class="card-body py-2 px-3">
                  <div class="text-muted text-uppercase fs-4xs mb-1" l10nTranslate>Password name</div>
                  <div class="fs-xs">{{ generatedPassword.name }}</div>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="card dialog-check-card h-100">
                <div class="card-body py-2 px-3">
                  <div class="text-muted text-uppercase fs-4xs mb-1" l10nTranslate>Application</div>
                  <div class="fs-xs">{{ generatedPassword.app | translate: locale.language }}</div>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="card dialog-check-card h-100">
                <div class="card-body py-2 px-3">
                  <div class="text-muted text-uppercase fs-4xs mb-1" l10nTranslate>Expiration</div>
                  <div class="fs-xs">
                    @if (generatedPassword.expiration) {
                      {{ generatedPassword.expiration | amDateFormat:'L' }}
                    } @else {
                      {{ 'never' | translate: locale.language }}
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="card dialog-check-card">
            <div class="card-body py-2 px-3">
              <div class="d-flex align-items-center gap-2">
                <div class="text-muted text-uppercase fs-4xs flex-shrink-0" l10nTranslate>Generated password</div>
                <div class="font-monospace fs-xs text-center flex-grow-1 text-truncate px-2">{{ generatedPassword.password }}</div>
                <button class="btn btn-sm btn-outline-success flex-shrink-0"
                        (click)="clipBoardPassword()"
                        type="button">
                  <fa-icon [icon]="icons.faCopy" class="me-1"></fa-icon>
                  <span l10nTranslate>Copy</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    }

    @if (appPasswords.length) {
      <div class="card dialog-tab-card">
        <div class="card-body p-2 d-flex flex-column gap-2">
          <div class="d-flex align-items-center text-muted text-uppercase fs-3xs fw-semibold px-1 pt-1">
            <span l10nTranslate>Existing passwords</span>
            <span class="badge bg-secondary ms-auto">{{ appPasswords.length }}</span>
          </div>

          @for (p of appPasswords; track p.name) {
            <div class="card dialog-check-card">
              <div class="card-body p-2">
                <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap mb-2">
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-success">{{ p.app | translate: locale.language }}</span>
                    <span class="fw-semibold fs-xs">{{ p.name }}</span>
                  </div>
                  <button class="btn btn-sm btn-outline-danger" (click)="deleteAppPassword(p.name)" l10nTranslate>Delete</button>
                </div>

                <div class="row g-2 fs-3xs">
                  <div class="col-12 col-md-4">
                    <div class="text-muted text-uppercase fw-semibold" l10nTranslate>Access</div>
                    <div>{{ p.currentAccess ? (p.currentAccess | amDateFormat) : '-' }}</div>
                    @if (p.lastAccess) {
                      <div>{{ p.lastAccess | amDateFormat }}</div>
                    }
                  </div>
                  <div class="col-12 col-md-3">
                    <div class="text-muted text-uppercase fw-semibold">IP</div>
                    <div>{{ p.currentIp || '-' }}</div>
                    @if (p.lastIp) {
                      <div>{{ p.lastIp }}</div>
                    }
                  </div>
                  <div class="col-12 col-md-2">
                    <div class="text-muted text-uppercase fw-semibold" l10nTranslate>Expiration</div>
                    <div>{{ p.expiration ? (p.expiration | amDateFormat:'L') : ('never' | translate: locale.language) }}</div>
                  </div>
                  <div class="col-12 col-md-3">
                    <div class="text-muted text-uppercase fw-semibold" l10nTranslate>Created</div>
                    <div>{{ p.createdAt | amDateFormat }}</div>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    } @else {
      <div class="card dialog-tab-card">
        <div class="card-body text-center text-muted py-4" l10nTranslate>
          No application password
        </div>
      </div>
    }
  </div>
</div>
<div class="modal-footer">
  <button (click)="onClose()" class="btn btn-sm btn-secondary" data-dismiss="modal" type="button" l10nTranslate>Close</button>
</div>
