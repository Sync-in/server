<!--
  ~ Copyright (C) 2012-2025 Johan Legrand <johan.legrand@sync-in.com>
  ~ This file is part of Sync-in | The open source file sync and share solution
  ~ See the LICENSE file for licensing details
  -->

<div class="modal-header align-items-center">
  <h4 class="modal-title">
    <fa-icon [icon]="icons.faKey" class="me-2"></fa-icon>
    <span l10nTranslate>Manage app passwords</span>
  </h4>
  <button (click)="onClose()" aria-label="Close" class="btn-close btn-close-white ms-auto" type="button"></button>
</div>
<div class="modal-body">
  @if (allowGeneration && !generatedPassword) {
    <div class="d-flex flex-fill flex-column">
      <div class="fw-500 mb-3" l10nTranslate>Generate a new app password</div>
      <div class="d-flex flex-column align-items-start">
        <form [formGroup]="appPasswordForm" (ngSubmit)="genAppPassword()" class="w-100">
          <div class="input-group input-group-sm flex-nowrap">
            <input appAutofocus
                   name="name"
                   formControlName="name"
                   type="text"
                   class="flex-grow-1 form-control form-control-sm pe-0"
                   [class.is-invalid]="appPasswordForm.controls.name.invalid"
                   [placeholder]="'Password name' | translate: locale.language" required>
            <div class="input-group-text" l10nTranslate>Application</div>
            <select class="form-select form-select-sm" formControlName="app" style="max-width: 150px">
              @for (s of availableApps; track $index) {
                <option [value]="s" l10nTranslate>{{ s }}</option>
              }
            </select>
            <input
              bsDatepicker
              id="expiration"
              formControlName="expiration"
              placement="bottom"
              type="text"
              class="form-control form-control-sm"
              style="max-width: 120px;"
              [placeholder]="'Never expires' | translate:locale.language"
              [bsConfig]="{
          dateInputFormat: 'YYYY-MM-DD',
          containerClass: 'theme-dark-blue',
          returnFocusToInput: true,
          minDate: minDate,
          showWeekNumbers: false }">
            <button
              [disabled]="appPasswordForm.invalid || submitted"
              class="btn btn-xs btn-primary"
              type="submit"
              l10nTranslate>
              Generate
            </button>
          </div>
        </form>
      </div>
    </div>
    @if (!this.generatedPassword) {
      @if (hasError) {
        <div class="alert alert-danger text-center my-3" l10nTranslate>
          {{ hasError }}
        </div>
      } @else {
        <div class="alert alert-secondary text-center my-3" l10nTranslate>
          This password will only be shown once after it is generated
        </div>
      }
      @if (appPasswords.length) {
        <hr class="mb-1 mt-4">
      }
    }
  }
  @if (generatedPassword) {
    <div class="d-flex flex-column alert alert-success text-center my-3">
      <div class="d-flex">
        <strong l10nTranslate>Password name</strong>:&nbsp;{{ generatedPassword.name }}
      </div>
      <div class="d-flex">
        <strong l10nTranslate>Application</strong>:&nbsp;{{ generatedPassword.app | translate: locale.language }}
      </div>
      @if (generatedPassword.expiration) {
        <div class="d-flex">
          <strong l10nTranslate>Expiration</strong>:&nbsp;{{ generatedPassword.expiration }}
        </div>
      }
      <div class="d-flex">
        <strong l10nTranslate>Generated password</strong>:&nbsp;
        <span class="font-monospace link-body-emphasis" (click)="clipBoardPassword()" role="button">
              <fa-icon [icon]="icons.faCopy"></fa-icon>
              <span>{{ generatedPassword.password }}</span>
            </span>
      </div>
    </div>
    @if (appPasswords.length) {
      <hr class="mb-1 mt-4">
    }
  }
  @if (appPasswords.length) {
    <table class="table table-striped table-hover align-middle text-center">
      <thead>
      <tr>
        <th scope="col" l10nTranslate>Name</th>
        <th scope="col" l10nTranslate>Application</th>
        <th scope="col" l10nTranslate>Access</th>
        <th scope="col" l10nTranslate>IP</th>
        <th scope="col" l10nTranslate>Expiration</th>
        <th scope="col" l10nTranslate>Created</th>
        <th scope="col" l10nTranslate>Action</th>
      </tr>
      </thead>
      <tbody class="table-group-divider">
        @for (p of appPasswords; track p.name) {
          <tr>
            <td>{{ p.name }}</td>
            <td>{{ p.app | translate: locale.language }}</td>
            <td class="fs-xxxs">
              <div class="d-flex flex-column align-items-center justify-content-center">
                <div>{{ p.currentAccess ? (p.currentAccess | amDateFormat) : '-' }}</div>
                @if (p.lastAccess) {
                  <div>{{ p.lastAccess | amDateFormat }}</div>
                }
              </div>
            </td>
            <td class="fs-xxxs">
              <div class="d-flex flex-column align-items-center justify-content-center">
                <div>{{ p.currentIp || '-' }}</div>
                @if (p.lastIp) {
                  <div>{{ p.lastIp }}</div>
                }
              </div>
            </td>
            <td class="fs-xxxs">{{ p.expiration ? (p.expiration | amDateFormat:'L') : ('never' | translate: locale.language) }}</td>
            <td class="fs-xxxs">{{ p.createdAt | amDateFormat }}</td>
            <td>
              <button class="btn btn-sm btn-outline-danger" (click)="deleteAppPassword(p.name)">Delete</button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  }
</div>
<div class="modal-footer">
  <button [ngModel]="allowGeneration"
          (ngModelChange)="onAllowGenerationChange()"
          class="btn btn-sm btn-outline-success me-auto"
          role="button"
          type="button"
          btnCheckbox
          l10nTranslate>
    <fa-icon [icon]="icons.faPlus"></fa-icon>
    <fa-icon [icon]="icons.faKey"></fa-icon>
    Password
  </button>
  <button (click)="onClose()" class="btn btn-sm btn-secondary" data-dismiss="modal" type="button" l10nTranslate>Close</button>
</div>




