<div class="profile-page" appAutoResize [resizeOffset]="40">
  <div class="container-fluid p-2">
    @if (user) {
      <div class="row g-3">
        <div class="col-12 col-lg-6 d-flex flex-column gap-3">
          <div class="card dialog-tab-card">
            <div class="card-body">
              <div class="user-header p-0">
                <div class="d-flex flex-column justify-content-center me-2">
                  <div class="avatar-xl">
                    <img [src]="userAvatar" class="avatar-img profile-user-img" alt="">
                    <span class="avatar-{{allOnlineStatus[user.onlineStatus]}}"></span>
                  </div>
                </div>

                <div class="user-details">
                  <div class="mb-1">{{ user.fullName }}</div>
                  <div class="mb-2 fs-2xs text-nowrap">{{ user.email }}</div>
                  <div class="text-muted fs-2xs">
                    {{ 'Member since' | translate:locale.language }} {{ user.createdAt | amTimeAgo:true }}
                  </div>

                  <select [(ngModel)]="user.onlineStatus"
                          (ngModelChange)="setOnlineStatus($event)"
                          class="form-select form-select-sm my-auto mt-2">
                    @for (n of allOnlineStatus; track $index) {
                      <option [ngValue]="allOnlineStatus.indexOf(n)">
                        {{ n | translate:locale.language | capitalize }}
                      </option>
                    }
                  </select>
                </div>
              </div>

              <div>
                <div class="px-1 mt-4">
                  <div class="row g-2 align-items-center py-2 border-bottom border-secondary-subtle">
                    <label for="" class="col-5 col-sm-4" l10nTranslate>Login</label>
                    <span class="col-7 col-sm-8 text-end">{{ user.login }}</span>
                  </div>

                  <div class="row g-2 align-items-center py-2 border-bottom border-secondary-subtle">
                    <label for="" class="col-5 col-sm-4" l10nTranslate>IP Addresses</label>
                    <div class="col-7 col-sm-8 d-flex flex-wrap justify-content-end">
                      <span class="badge bg-success">{{ user.currentIp }}</span>
                      <span class="badge bg-secondary-alt ms-1">{{ user.lastIp }}</span>
                    </div>
                  </div>

                  <div class="row g-2 align-items-center py-2 border-bottom border-secondary-subtle">
                    <label for="" class="col-5 col-sm-4" l10nTranslate>Connections</label>
                    <div class="col-7 col-sm-8 d-flex flex-wrap justify-content-end">
                      <span class="badge bg-success">{{ user.currentAccess | amDateFormat }}</span>
                      <span class="badge bg-secondary-alt ms-1">{{ user.lastAccess | amDateFormat }}</span>
                    </div>
                  </div>

                  @if (user.isUser) {
                    <div class="row g-2 align-items-center py-2 border-bottom border-secondary-subtle">
                      <label for="" class="col-5 col-sm-4" l10nTranslate>Permissions</label>
                      <div class="col-7 col-sm-8 d-flex flex-wrap justify-content-end">
                        @if (user.isAdmin) {
                          <span class="badge bg-purple">
                            <fa-icon [icon]="icons.faKey"></fa-icon>
                            <span l10nTranslate>Administrator</span>
                          </span>
                        } @else {
                          @for (app of user.applications; track $index) {
                            <span class="badge bg-purple m-1" l10nTranslate>{{ app }}</span>
                          }
                        }
                      </div>
                    </div>

                    <div class="row g-2 align-items-center py-2 border-bottom border-secondary-subtle">
                      <label for="" class="col-5 col-sm-4" l10nTranslate>Storage Space</label>
                      <div class="col-7 col-sm-8 d-flex justify-content-end">
                        <app-storage-usage class="w-100" style="max-width: 18rem;" [item]="user"></app-storage-usage>
                      </div>
                    </div>
                  }

                  <div class="row g-2 align-items-center pt-2">
                    <label for="" class="col-5 col-sm-4">WebDAV</label>
                    <div class="col-7 col-sm-8 text-end text-truncate">
                      <span
                        (click)="clipBoardLink()"
                        [title]="webdavUrl"
                        class="badge bg-primary d-inline-flex align-items-center gap-1 cursor-pointer">
                        <fa-icon [icon]="icons.faCopy"></fa-icon>
                        {{ webdavUrl }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card dialog-tab-card">
            <div class="card-body">
              <div class="text-muted text-uppercase fs-3xs fw-semibold mb-2" l10nTranslate>Preferences</div>

              @if (showEditorPreference) {
                <div class="row g-2 align-items-center mb-2">
                  <span class="col-12 col-sm-5" l10nTranslate>Document editor</span>
                  <div class="col-12 col-sm-7">
                    <select
                      class="form-select form-select-sm"
                      [ngModel]="userEditorPreference"
                      (ngModelChange)="updateEditorPreference($event)">
                      <option [ngValue]="null" l10nTranslate>Ask Me</option>
                      @for (e of editors | keyvalue: originalOrderKeyValue; track e.key) {
                        <option [ngValue]="e.value">{{ e.key }}</option>
                      }
                    </select>
                  </div>
                </div>
                <div class="text-muted fs-2xs mb-3" l10nTranslate>
                  Used when both editors support the file type.
                </div>
              }

              @if (user.isUser) {
                <div class="row g-0">
                  <div class="col-12">
                    <div class="card dialog-check-card dialog-check-card--interactive"
                         [class.dialog-check-card--active]="user.storageIndexing"
                         (click)="updateStorageIndexing(!user.storageIndexing)">
                      <div class="card-body p-2">
                        <div class="d-flex align-items-center cursor-pointer">
                          <label for="prefSwitchFullText" class="form-label me-auto text-nowrap" l10nTranslate>Full-text search</label>
                          <div class="d-flex align-items-center form-check form-switch ps-0 mb-0">
                            <label class="form-check-label" for="prefSwitchFullText" (click)="$event.stopPropagation()"></label>
                            <input
                              [ngModel]="user.storageIndexing"
                              (ngModelChange)="updateStorageIndexing($event)"
                              (click)="$event.stopPropagation()"
                              class="form-check-input ms-2"
                              id="prefSwitchFullText"
                              type="checkbox"
                              role="button">
                          </div>
                        </div>
                        <div class="text-muted fs-2xs mt-2 px-1" l10nTranslate>
                          Enable content indexation for personal files.
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6 d-flex flex-column gap-3">
          <div class="card dialog-tab-card">
            <div class="card-body">
              <div class="text-muted text-uppercase fs-3xs fw-semibold mb-2" l10nTranslate>Configuration</div>
              <div class="d-flex flex-column gap-2">
                @if (user.isUser) {
                  <div class="row g-2 align-items-center">
                    <label for="" class="form-label col-12 col-md-6 mb-0" l10nTranslate>Avatar</label>
                    <div class="col-12 col-md-6">
                      <div class="d-flex flex-wrap gap-2">
                        <button (click)="genAvatar()" class="btn btn-xs btn-success" type="button" l10nTranslate>Generate</button>
                        <button class="btn-file-upload btn btn-xs btn-default" type="button">
                          <span l10nTranslate>Import</span>
                          <input (change)="uploadAvatar($event)" accept="image/*" name="file" role="button" type="file" />
                        </button>
                      </div>
                    </div>
                  </div>
                }

                <div class="row g-2 align-items-center">
                  <label class="form-label col-12 col-md-6 mb-0" for="userLanguage" l10nTranslate>Language</label>
                  <div class="col-12 col-md-6">
                    <select id="userLanguage" [(ngModel)]="language" class="form-select form-select-sm">
                      @for (l of languages; track $index) {
                        <option [ngValue]="l">{{ i18nLanguageText[l] }}</option>
                      }
                    </select>
                  </div>
                </div>

                <div class="row g-2 align-items-center">
                  <label class="form-label col-12 col-md-6 mb-0" for="userNotification" l10nTranslate>Notification</label>
                  <div class="col-12 col-md-6">
                    <select id="userNotification"
                            [ngModel]="user.notification"
                            (ngModelChange)="updateNotification($event)"
                            class="form-select form-select-sm">
                      @for (n of allNotifications; track $index) {
                        <option [ngValue]="allNotifications.indexOf(n)" l10nTranslate>{{ n }}</option>
                      }
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          @if (user.isUser) {
            <div class="card dialog-tab-card">
              <div class="card-body">
                <div class="text-muted text-uppercase fs-3xs fw-semibold mb-2" l10nTranslate>Password</div>
                <div class="d-flex flex-column gap-2">
                  <div class="row g-2 align-items-center">
                    <label for="" class="form-label col-12 col-md-6 mb-0">{{ 'current password' | translate:locale.language | capitalize }}</label>
                    <div class="col-12 col-md-6">
                      <app-input-password [(password)]="oldPassword" placeholder="current password"></app-input-password>
                    </div>
                  </div>

                  <div class="row g-2 align-items-center">
                    <label for="" class="form-label col-12 col-md-6 mb-0" l10nTranslate>{{ 'new password' | translate:locale.language | capitalize }}</label>
                    <div class="col-12 col-md-6">
                      <app-input-password [(password)]="newPassword"
                                          [disabled]="!oldPassword?.length"
                                          [isRequired]="!!oldPassword?.length"
                                          [passwordMinLength]="passwordMinLength"
                                          [showGenerator]="true"
                                          placeholder="new password"></app-input-password>
                    </div>
                  </div>

                  @if (newPassword) {
                    <div class="row g-2">
                      <div class="col-12 col-md-6 offset-md-6">
                        <app-password-strength-bar [passwordToCheck]="newPassword"></app-password-strength-bar>
                      </div>
                    </div>
                  }

                  <div class="row g-2">
                    <div class="col-12 col-md-6 offset-md-6">
                      <button [disabled]="!newPassword || !oldPassword || newPassword.length < passwordMinLength"
                              (click)="submitPassword()"
                              class="btn btn-xs btn-primary text-nowrap"
                              type="button"
                              l10nTranslate>
                        Update
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card dialog-tab-card flex-grow-1">
              <div class="card-body">
                <div class="text-muted text-uppercase fs-3xs fw-semibold mb-2" l10nTranslate>Security</div>
                <div class="d-flex flex-column gap-3">
                  <div class="row g-2 align-items-center">
                    <label for="" class="form-label col-12 col-md-6 mb-0" l10nTranslate>Two-Factor Authentication</label>
                    <div class="col-12 col-md-6 d-flex flex-wrap align-items-center gap-2">
                      <button (click)="enable2Fa()"
                              [disabled]="!store.server().twoFaEnabled"
                              class="btn btn-xs btn-primary"
                              type="button"
                              l10nTranslate>
                        {{ user.twoFaEnabled ? 'Reset' : 'Enable' }}
                      </button>
                      @if (user.twoFaEnabled) {
                        <button (click)="disable2Fa()"
                                [disabled]="!store.server().twoFaEnabled"
                                class="btn btn-xs btn-danger"
                                type="button"
                                l10nTranslate>
                          Disable
                        </button>
                      }
                    </div>
                  </div>

                  <div class="row g-2 align-items-center">
                    <label for="" class="form-label col-12 col-md-6 mb-0" l10nTranslate>Application Passwords</label>
                    <div class="col-12 col-md-6 d-flex align-items-center">
                      <button (click)="manageAppPasswords()"
                              class="btn btn-xs btn-primary"
                              type="button"
                              l10nTranslate>
                        @if (user.appPasswords > 0) {
                          <div class="d-flex align-items-center gap-2">
                            <span l10nTranslate>Manage</span>
                            <span class="badge badge-small bg-primary">{{ user.appPasswords }}</span>
                          </div>
                        } @else {
                          <span l10nTranslate>Generate</span>
                        }
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }
  </div>
</div>
